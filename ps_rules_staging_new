-new_name= perfect_shelf_compliance

SELECT 
a.visit_id, 
b.visit_date_key, 
b.store_id, 
b.owner_id, 
b.categ_name, 
a.display_group, 
split_part(a.kpi_group1::text, ' - '::character varying::text, 1)::character varying AS brand, 
split_part(a.kpi_group1::text, ' - '::character varying::text, 2)::character varying AS segment, 
            CASE
                WHEN a.compliant = true THEN 1
                ELSE 0
        END AS compliance, 
c.weight
   FROM procter_and_gamble_es_pharma.storechecks_kpi_fact a, procter_and_gamble_es_pharma.storechecks_visit_fact_view b, procter_and_gamble_es_pharma.ps_weight c
  WHERE 
  a.visit_id = b.visit_id 
  AND split_part(a.kpi_group1::text, ' - '::character varying::text, 1) = c.brand::text 
  AND a.display_group::text = c.ps::text AND a.kpi_group1::text <> ''::character varying::text 
  AND a.display_group::text !~~ '%Share of%'::character varying::text 
  AND split_part(a.kpi_group1::text, ' - '::character varying::text, 2) <> ''::character varying::text 
  AND b.quarter_rank = 1 AND b.daily_rank = 1 
  AND (a.kpi_group1::text || a.display_group::text) <> 'Oral B - POCOral B - Permanent Display'::character varying::text
  and a.visit_id='61dcbcb054cf810006695f6e'
  GROUP BY a.visit_id, b.visit_date_key, b.store_id, b.owner_id, b.categ_name, a.display_group, a.kpi_group1,compliance, c.weight;
